const testingJson = {
  language_localname: '日本語',
  videofilename: null,
  parodys: [ { url: '/series/one%20piece-all.html', parody: 'one piece' } ],
  related: [ 2173803, 2173169, 2158596, 2152684, 2136295 ],
  scene_indexes: [],
  characters: null,
  tags: [ { url: '/tag/variant%20set-all.html', tag: 'variant set' } ],
  video: null,
  languages: [],
  type: 'artistcg',
  japanese_title: '[NEL-ZEL FORMULA][続・姉妹サンド]',
  title: "zoku shimaisan'do",
  language_url: '/index-japanese.html',
  artists: null,
  date: '2022-03-29 07:27:00-05',
  id: '2179989',
  files: [
    {
      height: 3318,
      haswebp: 1,
      hash: '43866792794e1ae339a8191e05219a48885c2898ed0290033a7ef35ea3da4003',
      hasavif: 1,
      name: '01_1.png',
      width: 4500
    },
    {
      hasavif: 1,
      haswebp: 1,
      height: 3318,
      hash: '3702f62c669d687018ec09f9f18b5b7938a7cff6cd4884d7079d1dba05d3b553',
      width: 4500,
      name: '02_2.png'
    },
    {
      hasavif: 1,
      hash: '2aa473054ca39eab5ec6aeb1e81b96332f3dd370ed0c744edb000a19bc113b16',
      height: 3318,
      haswebp: 1,
      name: '03_3.png',
      width: 4500
    },
    {
      hash: '6ca7680afac056e7c4bbaf70ab0ec74e701fdd9cac0ea1a13ab6688417120d0f',
      haswebp: 1,
      height: 3318,
      hasavif: 1,
      width: 4500,
      name: '04_4.png'
    },
    {
      haswebp: 1,
      height: 3318,
      hash: '64f483b51ca1ceb86e5ef9b047a08567c7eff97346785e8a9d2cb07fd852cda4',
      hasavif: 1,
      width: 4500,
      name: '05_5.png'
    },
    {
      height: 3318,
      haswebp: 1,
      hash: '5c04e07db00048d8a054b2c63063c5e238c4df03d5a0807a56449b1428d1495b',
      hasavif: 1,
      width: 4500,
      name: '06_6.png'
    },
    {
      name: '07_7.png',
      width: 4500,
      hash: '5c9c66948274429ae1af8856203a0f1021c549e821cf71b4c6cd921840899540',
      height: 3318,
      haswebp: 1,
      hasavif: 1
    },
    {
      hasavif: 1,
      hash: '2861698338a924408eb8a350a3784a9dd38cf697ed81c0a126742ea2d9d89db3',
      height: 3318,
      haswebp: 1,
      name: '08_8.png',
      width: 4500
    },
    {
      hasavif: 1,
      hash: '08864407fd1b1129035807d9f82f9650f7692b53a8d8bf93a4020f117688c295',
      haswebp: 1,
      height: 3318,
      width: 4500,
      name: '09_9.png'
    },
    {
      name: '10_10.png',
      width: 4500,
      height: 3318,
      haswebp: 1,
      hash: 'a4725e65113eec76ab3f5828dcac76dbfe90a7ddce3477cef30895489156834b',
      hasavif: 1
    },
    {
      hash: 'e72d5416accf71dcb4a5846fcc32de04c17e251fc8895c0e426f0a86c8488ce7',
      haswebp: 1,
      height: 3318,
      hasavif: 1,
      name: '11_11.png',
      width: 4500
    },
    {
      width: 4500,
      name: '12_12.png',
      haswebp: 1,
      height: 3318,
      hash: '5d400544d512ca1100c80e2f20e10af5aec0c82c15b74ee3331db13e2ec3efb7',
      hasavif: 1
    },
    {
      name: '13_13.png',
      width: 4500,
      hash: '71ce572bc0823d2b1af6b22315aa9607d18d797bf8b2e3015c2da5f13b7c4795',
      height: 3318,
      haswebp: 1,
      hasavif: 1
    },
    {
      name: '14_14.png',
      width: 4500,
      height: 3318,
      haswebp: 1,
      hash: '3c9768144ea3db46f19cc16231662343454ec14a0974a4d95aa10ca6cea32061',
      hasavif: 1
    },
    {
      hasavif: 1,
      haswebp: 1,
      height: 3318,
      hash: '7352054fc2fd8de57157f0274eb1b218bedf727f9c28500a44f6dc7508c18d49',
      width: 4500,
      name: '15_15.png'
    },
    {
      height: 3318,
      haswebp: 1,
      hash: '8a42dde6953c8333c16f1f81d18c3f6c075b63cee9856d059311dfbae743d5c8',
      hasavif: 1,
      width: 3305,
      name: '16_ss1.png'
    },
    {
      width: 3305,
      name: '17_ss2.png',
      hash: 'a21dea7c5b082a2a2298463e76ce79656de3bea3ab6a25c2089dd201f7a4abca',
      haswebp: 1,
      height: 3318,
      hasavif: 1
    },
    {
      hasavif: 1,
      haswebp: 1,
      height: 3318,
      hash: 'b6c2777d3067717d2f3d02f2990653c573b8cfb27319d18464ac07ce814074de',
      name: '18_ss3.png',
      width: 3305
    },
    {
      hasavif: 1,
      hash: '62c5000be26cea7f0028f76a8183868d1f918aa4c5d7bca0dd0dab8fe7164450',
      haswebp: 1,
      height: 3318,
      width: 3305,
      name: '19_ss4.png'
    },
    {
      name: '20_ss5.png',
      width: 3305,
      hasavif: 1,
      hash: '9ed120793f26b1aacbb91f3dc5301c8da29270f32db90992e6b97252024e0d41',
      height: 3318,
      haswebp: 1
    },
    {
      hasavif: 1,
      haswebp: 1,
      height: 3318,
      hash: '038edc89bea583a1ae317fe48cc83343fb5952deb00ab41d0f9399bcadf40a7d',
      width: 3305,
      name: '21_ss6.png'
    },
    {
      name: '22_ss7.png',
      width: 3305,
      haswebp: 1,
      height: 3318,
      hash: '402cfa55f0a5769f2f312ead96516f4908b69b0b14911178ee31bfd589c303c4',
      hasavif: 1
    },
    {
      width: 3305,
      name: '23_ss8.png',
      hasavif: 1,
      height: 3318,
      haswebp: 1,
      hash: '15a4cb6314f1fd01878acfab3344215d63dc7bd2905eb547c9d15fa879ee712d'
    },
    {
      hasavif: 1,
      haswebp: 1,
      height: 3318,
      hash: '22b70f4b9f351d4c61ab30c9d01bbfa82ce6ccfaa510c8178843abaf9e769d8e',
      name: '24_SSno1.png',
      width: 3305
    },
    {
      width: 3305,
      name: '25_SSno2.png',
      hash: '295e9e1e104b48ec9691d57d206ab69a55fddf99b82eb444f309610eb9257b9f',
      height: 3318,
      haswebp: 1,
      hasavif: 1
    },
    {
      name: '26_SSno3.png',
      width: 3305,
      haswebp: 1,
      height: 3318,
      hash: 'a1c652c6bc716b8464ef2afaeb925d89b907e487b380dd5154269f1cc8467cdd',
      hasavif: 1
    },
    {
      hasavif: 1,
      height: 3318,
      haswebp: 1,
      hash: 'f3d9db534ee202e9348288a9d92d27ecd5e1115d339241568f7cd04e7cfd3756',
      name: '27_SSno4.png',
      width: 3305
    },
    {
      name: '28_SSno5.png',
      width: 3305,
      hash: '212233877a3ea3a16105dd309ecf96f0cab1ac4dc3906fab633c73b0f4765908',
      height: 3318,
      haswebp: 1,
      hasavif: 1
    },
    {
      name: '29_SSno6.png',
      width: 3305,
      hasavif: 1,
      hash: '1ab4414a48f446af67f4d380a917933f9847bc61ea0370886d4bb8d65f1986b4',
      height: 3318,
      haswebp: 1
    },
    {
      hasavif: 1,
      height: 3318,
      haswebp: 1,
      hash: 'd341520a9e4ea6de6cbc1b11427e26baaa7f69a14de11fdbbb01731ee56337f2',
      width: 3305,
      name: '30_SSno7.png'
    },
    {
      name: '31_SSno8.png',
      width: 3305,
      hasavif: 1,
      hash: '53305ed56b5c62d03611fa28dc22580e9ad4146c2146831e07b448fcc1b2e5cf',
      height: 3318,
      haswebp: 1
    },
    {
      name: '32_32.png',
      width: 4500,
      height: 3318,
      haswebp: 1,
      hash: '3836a00576dc6194ae10cdc98336deb1ddcf89c4b8928523e302bc4d0b0ae356',
      hasavif: 1
    },
    {
      height: 3318,
      haswebp: 1,
      hash: 'fee4ac31e0ad4ede30bcd80dc735c3ba2f29e8858f956a091e4cb0108bd0d15b',
      hasavif: 1,
      name: '33_2.png',
      width: 4500
    },
    {
      haswebp: 1,
      height: 3318,
      hash: '493b2e89f9f183b7057912ece24e2517ede79b6b1676393ba9c4b2bf0a533e95',
      hasavif: 1,
      width: 4500,
      name: '34_3.png'
    },
    {
      height: 3318,
      haswebp: 1,
      hash: '1fd0ca1caf7f20929511df5e2efc39db261ee7a1c00b8ebedec117169473dca4',
      hasavif: 1,
      name: '35_4.png',
      width: 4500
    },
    {
      haswebp: 1,
      height: 3318,
      hash: 'a5bb194fdbd8a87debbc13a569eb54e5899f802e235e227501f9dab028161634',
      hasavif: 1,
      width: 4500,
      name: '36_5.png'
    },
    {
      width: 4500,
      name: '37_6.png',
      haswebp: 1,
      height: 3318,
      hash: 'e85ffa7639a5053fbb9ebc028e30b46454e27b352b6e0da498ff40dc3424c59f',
      hasavif: 1
    },
    {
      width: 4500,
      name: '38_7.png',
      hasavif: 1,
      height: 3318,
      haswebp: 1,
      hash: '32758ea6f32dfbfd402b918e70a712d042f598f0a139d772fe28064cd1a5f2a5'
    },
    {
      name: '39_8.png',
      width: 4500,
      height: 3318,
      haswebp: 1,
      hash: '48e5d97227e90492f33dd82bababbb220fb554cc2502b863d12e746c22f3b71f',
      hasavif: 1
    },
    {
      hasavif: 1,
      height: 3318,
      haswebp: 1,
      hash: 'ae9fe0f9b0514bf87840b9e86aed1c7e5d6f12f42c5d41dc9f366c49c2deb09a',
      name: '40_9.png',
      width: 4500
    },
    {
      width: 4500,
      name: '41_10.png',
      hash: '09434404ee9df75bf3b7b09ccef6de6f936cc85ab49f35c703bb493e293c67b0',
      haswebp: 1,
      height: 3318,
      hasavif: 1
    },
    {
      height: 3318,
      haswebp: 1,
      hash: 'f331f47702040c1b327772dd5f9f8e9e59efbc30e8056adb494fc0ff80b4fd70',
      hasavif: 1,
      name: '42_11.png',
      width: 4500
    },
    {
      hasavif: 1,
      haswebp: 1,
      height: 3318,
      hash: '43c7f0abd4be00a8e7eaec2c81e2dc1749113f5e5c0ad6b88382145284c1ec0e',
      name: '43_12.png',
      width: 4500
    },
    {
      width: 4500,
      name: '44_13.png',
      haswebp: 1,
      height: 3318,
      hash: '239416ec393511285d5dde23d0c0713b2c727745e52694656311e935f582ed04',
      hasavif: 1
    },
    {
      name: '45_14.png',
      width: 4500,
      hasavif: 1,
      hash: '11f6ecb9334fef6d4a0524b1cda73c824b4c4461e57db7631bb0d95d668a20a2',
      height: 3318,
      haswebp: 1
    },
    {
      hasavif: 1,
      height: 3318,
      haswebp: 1,
      hash: '70f42f189a665be9bf87390466b300be932d2500056d0c54ee6440583d72ce98',
      name: '46_15.png',
      width: 4500
    },
    {
      width: 4500,
      name: '47_47.png',
      haswebp: 1,
      height: 3318,
      hash: 'b45e7cce90d641878a9ed218ce3c581a24067af943e6c6a91b1ef747e314834e',
      hasavif: 1
    }
  ],
  language: 'japanese',
  groups: [
    {
      group: 'nel-zel formula',
      url: '/group/nel%2Dzel%20formula-all.html'
    }
  ]
}

const { not } = require("cheerio/lib/api/traversing");

import cheerio from 'cheerio';
import {hentaieraData} from '../../types';
import vm from 'vm';
const {common} = require('../Util/commonFunction')
const HitomiFunction = require("./Hitomi");
const HentaieraFunction = require("./Hentaiera");

const sleep = (ms) => {
  return new Promise(resolve => setTimeout(resolve, ms));
}

const sleeping = async (ms) => { await sleep(ms) };

//모든 그림을 받아옵니다.
const getGalleryImgs = async(window,indexX,id,files) => {
  console.log(files)
  let listImage:string[] = []
  let indexNum:number;
  await Promise.all(files.map(async (file,indexY) => {
    let decodeUrl;
    decodeUrl = common.url_from_url_from_hash(id, file, 'webp', undefined, 'a')
    console.log(decodeUrl)
    let image = await hitomi.getGalleryImg(decodeUrl)
    console.log(image.data) 
    // window.webContents.send('LoadImage',image.data.toString('base64'),indexX * 5 + indexY)
    listImage.push(image.data.toString('base64'));
    indexNum = indexX * 5 + indexY;
  }));
  return {listImage,indexNum}
}

let hitomi = new HitomiFunction.Hitomi('https:','ltn.hitomi.la')
let hentaiera = new HentaieraFunction.Hentaiera()
console.log(hitomi.url)
class dataRequest{
  constructor(){
    this.init()
  }

  async init () {

  }
  //hitomi -> getImgs , getIndex, getLazyPage
  //hentaiera -> getIndex,
  static site = {
    Hitomi : {
      getIndex : async function (){
        let note:JSON[] = []
        let index = await hitomi.getIndexs(1,10)
        // console.log(index)
        await Promise.all(index.nozomi.map(async (element) => {
          const response  = await hitomi.getGalleryInfo(element)
          let temp = JSON.parse(response.replace("var galleryinfo = ",""))
          console.log(temp)
          note.push(temp)
        }));
        return note
      },
      getImgs : async function(window,listFiles = testingJson) {
        let data = await hitomi.getRequest("https://ltn.hitomi.la/gg.js"); //to get a js file from hitomi
        let ggFunction:string = data.data.toString().replace("gg","const gg")
        //vm은 버추얼 머신으로 코드를 대신 넣어주는 방법을 사용합니다.
        vm.runInThisContext(ggFunction)
        // const getGallery = async (window,listFiles = testingJson) => {
        // console.log(window,listFiles)
        let start:Date = new Date()
        //변동 값이 있는거 같아서 데이터를 항상 히토미에서 받아오는 방식으로 하였습니다.


        let nodeArray = []
        // window.webContents.send('preLoadImageContainer',listFiles);
        while(listFiles.files.length > 0){
          nodeArray.push(listFiles.files.splice(0,5))
        }
        let failArray:number[] = []
        let repsonseImg:{listImage:string[],indexNum:number}
        for(const [index, fileNode] of nodeArray.entries()){
          var radomDelay = Math.floor(Math.random() * 2)+ 1
          try{
            repsonseImg = await getGalleryImgs(window,index,listFiles.id,fileNode)
          }
          catch(e){
            console.log(e)
            failArray.push(repsonseImg.indexNum)
          }
          await sleeping(radomDelay * 50)
        }
        let end:Date = new Date()
        console.log((end.getTime() - start.getTime()) / 1000 + "초");
        console.log(failArray) 
      }
    },
    Hentaiera:{
      getIndex:async function(){
        let temp =  await hentaiera.getIndex()
        const $ = cheerio.load(temp.data)
        let arr = []
        $("div.thumb div div.inner_thumb a").map((index,element) => {
          let imgElement = $(element).find("img")
          let temp:hentaieraData = {
            href : $(element).attr('href'),
            img : $(imgElement).attr('src')
          }
          arr.push(temp);
          })
          console.log(arr)
      }
    }
  }
}

let data = new dataRequest();
const testingPorpose = async () => {
  let temp = await dataRequest.site.Hitomi.getImgs("");
  console.log('running');
  console.log(temp)
}

testingPorpose();