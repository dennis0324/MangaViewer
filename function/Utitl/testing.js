const testingJson = {
  characters: null,
  artists: [ { url: '/artist/sho%2Dyan-all.html', artist: 'sho-yan' } ],
  languages: [],
  tags: [
    {
      male: '',
      url: '/tag/female%3Alatex-all.html',
      female: 1,
      tag: 'latex'
    },
    {
      male: '',
      tag: 'sister',
      female: 1,
      url: '/tag/female%3Asister-all.html'
    },
    { url: '/tag/incest-all.html', tag: 'incest' },
    {
      url: '/tag/multi%2Dwork%20series-all.html',
      tag: 'multi-work series'
    }
  ],
  files: [
    {
      hasavif: 1,
      hash: 'e586621e5867eac8c575485a3132aea18ac974865e7dd5745ef69d4c3a19c3a7',
      haswebp: 1,
      height: 3507,
      name: '01.jpg',
      width: 2480
    },
    {
      haswebp: 1,
      height: 3000,
      hasavif: 1,
      hash: '471ff338d3031616a350dee6a4b35ecf12fdb1b2259ceaf763ad48ac4b574ed4',
      name: '02.jpg',
      width: 2150
    },
    {
      width: 2150,
      name: '03.jpg',
      hash: 'fc0fc1b28a1b5babd187585214f39344585062b86a1ed1cfe5b5685781e8957b',
      hasavif: 1,
      height: 3035,
      haswebp: 1
    },
    {
      width: 2150,
      name: '04.jpg',
      hash: '477085636491e7b172551bdb5c67dc05dac4cbda9225d830ca7286348b957e70',
      hasavif: 1,
      haswebp: 1,
      height: 3000
    },
    {
      width: 2150,
      name: '05.jpg',
      haswebp: 1,
      height: 3000,
      hash: '61c3a624bc75b92fe76a37257d0e62bd19a7e97921e372bf30e0565be7425a7a',
      hasavif: 1
    },
    {
      width: 2150,
      name: '06.jpg',
      hasavif: 1,
      hash: '52bd7f263b26c8004d2fbd313b68bf0fa0dbab232dda3cd88b77b03e2681e4c5',
      height: 3000,
      haswebp: 1
    },
    {
      name: '07.jpg',
      width: 2150,
      haswebp: 1,
      height: 3000,
      hash: '3df3be890f1a4292db35d82e7a231f604cc42ac1101cab111ec5afaab4ff2605',
      hasavif: 1
    },
    {
      hash: '8f95f6d506f3de03aa78b947f0a60e229a52a7e8dc24e24209743cb3d4873680',
      hasavif: 1,
      haswebp: 1,
      height: 3000,
      width: 2150,
      name: '08.jpg'
    },
    {
      name: '09.jpg',
      width: 2150,
      hash: '501480081357d8b7bd8780b20fd2628c77574cb5080c7cbe3422139455a50226',
      hasavif: 1,
      haswebp: 1,
      height: 3000
    },
    {
      width: 2150,
      name: '10.jpg',
      height: 3000,
      haswebp: 1,
      hash: '98f30415b0c256060dde0160807f37294f5ea764d1a27efa866477430e0b25ca',
      hasavif: 1
    },
    {
      hash: 'ca7d0ecc7ee0763781ccbbc7bb79346e6cf9753fb2262bee6c977902e996e8e1',
      hasavif: 1,
      height: 3000,
      haswebp: 1,
      width: 2150,
      name: '11.jpg'
    },
    {
      width: 2150,
      name: '12.jpg',
      hash: 'f8c4de341916c526d24bfe689d355ab391cf7faf10b9fc996488acd2ebd84edb',
      hasavif: 1,
      haswebp: 1,
      height: 3000
    },
    {
      height: 3000,
      haswebp: 1,
      hasavif: 1,
      hash: '0060e73c5d7b0fdcb1584688b104de4b657c1ab7083b75c3d1dbe287cd01d3eb',
      width: 2150,
      name: '13.jpg'
    },
    {
      hasavif: 1,
      hash: '452ad11fcf6844300a15827e31505ca6bf001f23dd37e2b788d7230d3c27ad69',
      haswebp: 1,
      height: 3000,
      width: 2150,
      name: '14.jpg'
    },
    {
      name: '15.jpg',
      width: 2150,
      height: 3000,
      haswebp: 1,
      hash: '0a5b312141a07c66e4c1b4bb92d588ab7f5af9eee6ac09800cd014856cb03266',
      hasavif: 1
    },
    {
      name: '16.jpg',
      width: 2150,
      height: 3000,
      haswebp: 1,
      hash: '68341d94520683c5c03b9fb077f917de4d2e485a5e6977c6cb4e4ae1643596fa',
      hasavif: 1
    },
    {
      hash: '9240903ea88262d670d4f80a182a65502fb11df9e6cdd9208394b98d1005af03',
      hasavif: 1,
      haswebp: 1,
      height: 3000,
      width: 2150,
      name: '17.jpg'
    },
    {
      name: '18.jpg',
      width: 2150,
      height: 3000,
      haswebp: 1,
      hasavif: 1,
      hash: '894aa4c9b8524a4cc9547d0caf29347ba5f5643c597646d796afe5a6c96beb40'
    },
    {
      height: 3000,
      haswebp: 1,
      hash: '37e27fa2d3e2ca782af7c87286d14c1511f46ba7081201fb3708c64e8939d873',
      hasavif: 1,
      width: 2150,
      name: '19.jpg'
    },
    {
      name: '20.jpg',
      width: 2150,
      height: 3000,
      haswebp: 1,
      hash: '65da62830369ba284b55acb437e0b28a28a6a5a17a3c6adafb0c68f95b6a58c8',
      hasavif: 1
    },
    {
      width: 2150,
      name: '21.jpg',
      height: 3000,
      haswebp: 1,
      hash: 'de9e7c26e841da4097b74f9cbd2fecda84a1b706a3e5a9a3be86785ed77683a0',
      hasavif: 1
    },
    {
      width: 2150,
      name: '22.jpg',
      hasavif: 1,
      hash: '7b81841ec2cb106cb041f8bd986069fd9ffcd27d3b438f79e093145b00eecfbe',
      height: 3000,
      haswebp: 1
    },
    {
      hash: 'feaad4d88d105e1cbca29fc79406fbd28ed316861351477de4405830d30ba070',
      hasavif: 1,
      haswebp: 1,
      height: 3000,
      width: 2150,
      name: '23.jpg'
    },
    {
      hasavif: 1,
      hash: 'bde527abf42918dc9406ed895d289422930f97e236060918384809284e8d0866',
      height: 3000,
      haswebp: 1,
      name: '24.jpg',
      width: 2150
    },
    {
      height: 3000,
      haswebp: 1,
      hasavif: 1,
      hash: '5d64f17fdac942da5ef3d627116a7d39f787f58678ab78ca21e691fe621d7e06',
      width: 2150,
      name: '25.jpg'
    },
    {
      width: 2150,
      name: '26.jpg',
      height: 3000,
      haswebp: 1,
      hasavif: 1,
      hash: 'bd31cf9c1d6c7552b77bf3c82c383bb5d96a576d9dc380cc4f86be251bbbd22b'
    },
    {
      name: '27.jpg',
      width: 2150,
      hash: '87fc40ced5f4714e43beb5a395e3d1fbda06067f5b58ff1788158102ce362e65',
      hasavif: 1,
      haswebp: 1,
      height: 3000
    },
    {
      height: 3035,
      haswebp: 1,
      hasavif: 1,
      hash: '590d9bce429518214084f70b67076477e52ea5984b75857431c9dabbbc51bb80',
      name: '28.jpg',
      width: 2150
    },
    {
      width: 2150,
      name: '29.jpg',
      hasavif: 1,
      hash: '20c5e3ae25bdf3aef5b41499d9ef3dc3b94a88f448f344bbe8dafe1c2ae7cc7e',
      haswebp: 1,
      height: 3000
    },
    {
      hash: '7e6b4dcade91a64b4bf3c461a41561e8fbe8938bdb0906a2d54330b2d4235fd3',
      hasavif: 1,
      haswebp: 1,
      height: 3000,
      width: 2150,
      name: '30.jpg'
    },
    {
      height: 3000,
      haswebp: 1,
      hash: '9d9a7576574f42b6e00f77704bf23f6530d8341e08886415df48e29218b0aa6b',
      hasavif: 1,
      name: '31.jpg',
      width: 2150
    },
    {
      hasavif: 1,
      hash: '9768ffd0893e84fc9c005000f6a31de212eeafad81889d64d97c2ccbe8d96352',
      height: 3000,
      haswebp: 1,
      name: '32.jpg',
      width: 2150
    },
    {
      name: '33.jpg',
      width: 2150,
      haswebp: 1,
      height: 3000,
      hasavif: 1,
      hash: '909e7916796551925cee4c1c5cb379af7ad3dd4f0580139ae2356ff3994f34b8'
    },
    {
      name: '34.jpg',
      width: 2150,
      hash: '3275a6a77bbc801c3617c9374810ea363579b256e8ceaf73fab312b7e3cc4a9d',
      hasavif: 1,
      haswebp: 1,
      height: 3000
    },
    {
      height: 3000,
      haswebp: 1,
      hasavif: 1,
      hash: '235d63668dc922e088a8aa1cb7cd72d09587ca1f0054a689f0a2fcc7e1c62516',
      width: 2150,
      name: '35.jpg'
    },
    {
      hash: '71003d2b30a741190227ef8f6bded3aa955e039e8e417757447bc00cf6ebc08d',
      hasavif: 1,
      haswebp: 1,
      height: 3000,
      width: 2150,
      name: '36.jpg'
    },
    {
      width: 2150,
      name: '37.jpg',
      haswebp: 1,
      height: 3000,
      hasavif: 1,
      hash: 'dfc21e4886c8efadadac15827db4113395535f26914765224a464357f9d63b9a'
    },
    {
      hash: '5fbe887eaf25a0c616fe634296e66094bf2d3efbf219bec9fcfd93cb2c0e774d',
      hasavif: 1,
      height: 3035,
      haswebp: 1,
      width: 2150,
      name: '38.jpg'
    },
    {
      name: '39.jpg',
      width: 2480,
      haswebp: 1,
      height: 3507,
      hasavif: 1,
      hash: '3a233001e89f76599eb1e390366ef53336543b95c7d64ffecbd2b71985d192d0'
    }
  ],
  scene_indexes: [],
  related: [ 1464100, 2131300, 2119763, 2112985, 2109768 ],
  videofilename: null,
  language_localname: '日本語',
  language_url: '/index-japanese.html',
  parodys: [ { url: '/series/original-all.html', parody: 'original' } ],
  japanese_title: 'クロネコチョコアイス7',
  video: null,
  title: 'Kuroneko Choco Ice 7',
  groups: [
    {
      url: '/group/mousou%20bijutsubu-all.html',
      group: 'mousou bijutsubu'
    }
  ],
  date: '2022-03-26 10:21:00-05',
  language: 'japanese',
  type: 'doujinshi',
  id: '2177041'
}


function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}


const { default: axios } = require("axios");
const { not } = require("cheerio/lib/api/traversing");
const test = require("./getData");
const cheerio = require("cheerio");
const vm = require('vm');
const {common} = require('./commonFunction')
const randomUseragent = require('random-useragent');
const { wait } = require("nightmare/lib/actions");
const ua = randomUseragent.getRandom();


var Hitomi = test.Hitomi

let hitomi = new Hitomi();
// let makeURL = Hitomi.bind(data);
// let url = makeURL("index-all",".nozomi")

function full_path_from_hash(hash) {
  return gg.b+gg.s(hash)+'/'+hash;
}

async function processArray(array) {
  // map array to promises
  const promises = array.map(delayedLog);
  // wait until all promises are resolved
  await Promise.all(promises);
  console.log('Done!');
}

function real_full_path_from_hash(hash) {
  return hash.replace(/^.*(..)(.)$/, '$2/$1/'+hash);
}


function full_path_from_hash(hash) {
  return gg.b+gg.s(hash)+'/'+hash;
}

function url_from_hash(galleryid, image, dir, ext) {
  ext = ext || dir || image.name.split('.').pop();
  dir = dir || 'images';
  
  return 'https://a.hitomi.la/'+dir+'/'+full_path_from_hash(image.hash)+'.'+ext;
}


//id,title,language,date, type, releated, files, tags
note = []
const testing = async () => {

  let index = await hitomi.getIndex(1,5)
  await Promise.all(index.nozomi.map(async (element) => {
    const response  = await hitomi.getGalleryInfo(element)
    let temp = JSON.parse(response.replace("var galleryinfo = ",""))
    // console.log(temp)

    // getImages(temp)
    let image = await hitomi.getGalleryImg("https://aa.hitomi.la/webp/1648310402/45/3a233001e89f76599eb1e390366ef53336543b95c7d64ffecbd2b71985d192d0.webp")
    // console.log(image.data)
  }));


  // console.log(url_from_hash("",jsonTemp,'avif','avif'))

  // console.log(real_full_path_from_hash('9fe2fc3ad088b0af7a335a4a4d66cc379b705dac6ea3e94ff44b038cd68b7fc2'));
}



const getImages = async (listFiles) => {
  let listImage = []
  let prefix = ['a','b']
  let data = await hitomi.getRequest("https://ltn.hitomi.la/gg.js");
  ggFunction = data.data.toString().replace("gg","const gg")
  vm.runInThisContext(ggFunction)

  await Promise.all(listFiles.files.map(async (element,index) => {
    let decodeUrl = common.url_from_url_from_hash(listFiles.id, element, 'webp', undefined, 'a')
    // console.log(decodeUrl);
    let image = await hitomi.getGalleryImg(decodeUrl)
    console.log(index)
    listImage.push(image.data.toString('base64'));
    await sleep(5000)
  }));
}

const testingImage = async (url) =>{
  //https://aa.hitomi.la/webp/1648310402/45/3a233001e89f76599eb1e390366ef53336543b95c7d64ffecbd2b71985d192d0.webp
  let image = await hitomi.getGalleryImg("https://aa.hitomi.la/webp/1648310402/45/3a233001e89f76599eb1e390366ef53336543b95c7d64ffecbd2b71985d192d0.webp")
  // listImage.push(image.data.toString('base64'));
  console.log(image.data.toString('base64'));
}
//67f366f6a6973c1eb6e3220f232be003e99fc4f5a42693c7635789e3eaa11879
// testing();
getImages(testingJson)
// testingImage();


// console.log(real_full_path_from_hash('67f366f6a6973c1eb6e3220f232be003e99fc4f5a42693c7635789e3eaa11879'))